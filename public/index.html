<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farm Boy Industries</title>
  <link rel="stylesheet" href="css/main.css" />
</head>

<body>
  <header>
    <nav>
      <ul>
        <li>
          <a href="home.html" style="text-decoration:none;"> Home </a>
        </li>
        <li>
          <a href="about.html" style="text-decoration:none;"> About </a>
        </li>
        <li>
          <a href="contact.html" style="text-decoration:none;"> Contact Us </a>
        </li>
      </ul>
    </nav>
    <section class="banner"></section>
  </header>

  <main>
    <h1> Farm Boy Beef </h1>
    <p>
      Every day the boys give the cattle a fresh slice of pasture. When they approach the fence, the cattle are waiting
      impatiently; they know what’s coming! The new pasture is fenced off, and when the gate opens, they swoop in for a
      fresh salad lunch.
      It has taken a while to get to the point where we have not only produced enough beef to feed 20 hungry boys, but
      also sell to customers. There are soil samples to collect, hay to cut and bale, fences to put in, and weeds to cut
      out of the pasture. All his activity provides hours of meaningful work for the boys, food for their table, and
      financial support for their school.
      We are now ready for our first offering: organic, grass fed and grass finished beef! We are sending cattle to the
      butcher shop, and they will be ready soon. These cattle have never been fed grain, they have not been given shots
      or hormones, and the pastures are not sprayed with herbicides. This is good old fashioned pasture fed beef, and it
      is delicious!!!
    </p>
    <section class="products"></section>
  </main>

  <footer>

  </footer>

  <template id="product" >
    <div class="storegrid">
      <br>
      <br>
      <img src="" alt="" />
      <p class="description">description</p><br>
      <form action="/.netlify/functions/create-checkout" method="post" onchange="calculateTotal()" >
        <select id="packages" name="packages" >
          <option value="0" >Select a package</option>
          <option value="100" >$100 for 10 lbs</option>
          <option value="150">$150 for 15 lbs</option>
          <option value="200">$200 for 20 lbs</option>
        </select>
        <br><label for="quantity">Quantity</label>
        <input type="number" id="quantity" name="quantity" value="1" min="1" max="10"  />
        <input type="hidden" id="sku" name="sku" value="" /><br><br>
        <p>Pickup at farm for free </p>
        <p></p> Or</p>
        <p>Delivered to home for $17 <input type="checkbox" id="delivery" name="delivery" >
        </p>
        <br>
        <p>Additional contribution to Hope Farm </p>
        <div id="additionalamountdiv" >
          <input type="radio" name="additionalamount" id="additionalamount" value="0"> 0%
          <input type="radio" name="additionalamount" id="additionalamount" value="10"> 10%
          <input type="radio" name="additionalamount" id="additionalamount" value="20"> 20%
          <input type="radio" name="additionalamount" id="additionalamount" value="30"> 30%</p>
        </div>
        <br>
        <p>Total : <b>$<span id="total" name="total" class="total">0</span></b></p>
        <br>
        <input type="hidden" id="finalorder" name="finalorder" value="" />
        <button id="submitpayment" type="submit" disabled="true">Buy Now</button>
      </form>
    </div>
  </template>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    function calculateTotal() {
      var price = 0;
      var selectedPackage="";
      var packages = document.getElementById('packages');
      var finalOrder ="";
      if(packages==null){
        price =100;

      }else {
        price= packages.options[packages.selectedIndex].value;
        selectedPackage=packages.options[packages.selectedIndex].innerHTML;
        finalOrder=finalOrder+selectedPackage+" "
      }
     //var priceSplit = price.split("$");
      //var realprice = parseFloat(priceSplit[1]);
      var quantityElement = document.getElementById("quantity");
      var quantity=1;
      if(quantityElement!=null) {
      quantity=quantityElement.value;
      finalOrder=finalOrder + " quantity " +quantity  +" "

      }
      var additionalamountpercent = 0;
      var additionalamounts = document.getElementsByName('additionalamount');
      for (i = 0; i < additionalamounts.length; i++) {
        if (additionalamounts[i].checked) {
          additionalamountpercent = additionalamounts[i].value;
        }
      }
 
      var additionalamount = (additionalamountpercent / 100) * price * quantity

      finalOrder=finalOrder + " additional donation of " +additionalamountpercent +" % of $" + additionalamount;  

      var delivery = document.getElementById("delivery");
      var shippingAmount = 0;
      if (delivery!=null&&delivery.checked) {
        shippingAmount = 17;
        finalOrder=finalOrder+" and " +"  $"+shippingAmount+" for shipping" 
      } else {
        shippingAmount = 0;
        finalOrder=finalOrder+" pickup from farm" 
      }

    
      var total = price * quantity + shippingAmount + additionalamount;
      if (!isNaN(total))
        if(total>0){      
          document.getElementById("submitpayment").disabled = false

        }else {
          document.getElementById("submitpayment").disabled = true

        }
        document.getElementById("total").innerHTML = total
        document.getElementById("finalorder").value = finalOrder

    }
    function format(amount, currency) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency,
      }).format((amount / 100).toFixed(2));
    }

    async function handleSubmit(event) {
      event.preventDefault();
      document
        .querySelectorAll('button')
        .forEach((button) => (button.disabled = true));

      const form = new FormData(event.target);
      var finalorder = document.getElementById('finalorder').value;
      var quantityElement = document.getElementById("quantity");

      var delivery = document.getElementById("delivery");
      var shipping =false;
      if (delivery!=null&&delivery.checked) {
        shipping=true;  
      }

      const data = {
        sku: form.get('sku'),
        quantity: quantityElement.value,
        total: Number(document.getElementById('total').innerHTML)*100,
        package:finalorder,
        shipping:shipping
      };

      const response = await fetch('/.netlify/functions/create-checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      }).then((res) => res.json());

      const stripe = Stripe(response.publishableKey);
      const { error } = await stripe.redirectToCheckout({
        sessionId: response.sessionId,
      });

      if (error) {
        document
          .querySelectorAll('button')
          .forEach((button) => (button.disabled = false));
        console.error(error);
      }
    }

    async function loadProducts() {
      if (!'content' in document.createElement('template')) {
        console.error('Your browser doesn’t support HTML template elements.');
        return;
      }

      const data = await fetch('/.netlify/functions/get-products')
        .then((res) => res.json())
        .catch((err) => console.error(err));

      const products = document.querySelector('.products');
      const template = document.querySelector('#product');

      data.forEach((product) => {
        const container = template.content.cloneNode(true);

        //container.querySelector('h2').innerText = product.name;
        container.querySelector('.description').innerText =
          product.description;
        //container.querySelector('.price').innerText = format(
        //  product.amount,
        //  product.currency
       // );
        container.querySelector('[name=sku]').value = product.sku;
        container.querySelector('[name=total]').innerHTML = 0;
        const img = container.querySelector('img');
        img.src = product.image;
        img.alt = product.name;
        const form = container.querySelector('form');
        form.addEventListener('submit', handleSubmit);
        products.appendChild(container);
      });
    }

    loadProducts();
    //test();
  </script>

</body>

</html>